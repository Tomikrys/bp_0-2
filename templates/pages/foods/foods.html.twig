{% extends 'base.html.twig' %}
{% block title %}{% endblock %}
{% block stylesheets %}
    <style>
        .food_description {
            max-width: 300px;
        }
    </style>
{% endblock %}
{% block body %}
<h1>Foods</h1>

    <button type="button" class="btn btn-success mb-2" onclick="add_row_for_new_food()">Přidat řádek</button>
    <button type="button" class="btn btn-warning mb-2" onclick="save_all_changed()">Uložit změny</button>
    {{ include('pages/foods/parts/table.html.twig') }}

    {{ include('pages/foods/parts/formAddTag.html.twig') }}
    <button type="button" class="btn btn-success mb-2" onclick="add_row_for_new_food()">Přidat řádek</button>
    <button type="button" class="btn btn-warning mb-2" onclick="save_all_changed()">Uložit změny</button>


{% endblock %}
{% block javascripts %}
    <script>
        $(document).ready(function() {
            const foods = document.getElementById('foods');
            if (foods) {
                //    deleting item
                foods.addEventListener('click', e => {
                    const id = e.target.getAttribute('data-id');
                    if ($(e.target).hasClass('delete-food')) {
                        delete_food(id);
                    }
                    // adding item
                    if ($(e.target).hasClass('add-food')) {
                        add_food(id);
                    }

                    // editing item
                    if ($(e.target).hasClass('edit-food')) {
                        edit_food(id);
                        window.location.reload();
                    }

                    // adding tag
                    if ($(e.target).hasClass('add-tag')) {
                        alert('tag');
                        add_tag(e);
                    }
                });
            }

            only_numbers_listener();

            $('#foods tr').on("DOMSubtreeModified", function(){
                add_to_changed_foods(this);
            });
        });

        function delete_food(id) {
            if (confirm('Opravdu?')) {
                $("#loading").modal("show");

                fetch(`/foods/delete/${id}`, {
                    method: 'DELETE'
                }).then(res => window.location.reload());
            }
        }

        // function edit_tags(e) {
        //     $("#loading").modal("show");
        //         fetch(`/foods/${id}/editTags`, {
        //             method: 'PATCH'
        //         }).then(res => window.location.reload());
        //     $("#loading").modal("hide");
        // }

        function edit_food(id) {
            $("#loading").modal("show");
            // vytežení infa z tabulky
            const name = document.getElementById(id).getElementsByClassName("food_name")[0].innerText;
            const description = document.getElementById(id).getElementsByClassName("food_description")[0].innerText;
            const price = document.getElementById(id).getElementsByClassName("food_price")[0].innerText;

            // řešení selektu
            var selector = document.getElementById(id).getElementsByClassName("food_type")[0];
            var type = selector[selector.selectedIndex].getAttribute('data-id');

            // nacpání do struktury
            const data = {
                id: id,
                name: name,
                description: description,
                price: price,
                type: type
            };

            // odeslání do FoodController
            try {
                const response = fetch('/foods/edit', {
                    method: 'PATCH', // or 'PUT'
                    body: JSON.stringify(data), // data can be `string` or {object}!
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const json = response.json();
                console.log('Success:', JSON.stringify(json));
            } catch (error) {
                console.error('Error:', error);
            }
            $("#loading").modal("hide");
        }

        // přidání řádku a buňek do tabulky
        function add_row_for_new_food() {
            const foods = document.getElementById('foods');
            var row = foods.insertRow(-1);
            var cell_name =         row.insertCell(0);
            var cell_description =  row.insertCell(1);
            var cell_price =        row.insertCell(2);
            var cell_tags =         row.insertCell(3);
            var cell_type =         row.insertCell(4);
            var cell_buttons =      row.insertCell(5);

            // přidání "editovatelnosti"
            var editable = document.createAttribute("contenteditable");
            editable.value = "true";
            var editable2 = document.createAttribute("contenteditable");
            editable2.value = "true";
            var editable3 = document.createAttribute("contenteditable");
            editable3.value = "true";

            let id = "adding";
            let i = 0;
            while (document.getElementById(id)) {
                id = "adding" + i;
                i += 1;
                console.log(id);
            }

            row.id = id;
            row.classList.add("adding_row");

            cell_name.classList.add("food_name");
            cell_name.classList.add("font-weight-bold");
            cell_name.attributes.setNamedItem(editable);

            cell_description.classList.add("food_description");
            cell_description.attributes.setNamedItem(editable2);

            cell_price.innerHTML = " ";
            cell_price.classList.add("food_price");
            cell_price.classList.add("only-numbers");
            cell_price.attributes.setNamedItem(editable3);

            // řešení selektu
            cell_type.innerHTML =
                '<select class="food_type form-control">\n' +
                '   <option selected></option>' +
                '   {% for type in types %}\n'+
                '       <option data-id="{{ type.id }}">{{ type.name }}</option>\n'+
                '   {% endfor %}\n'+
                '</select>';

            // tlačítko k uložení
            cell_buttons.innerHTML = '<a href=\"#\" data-id=\"' + id + '\" class=\"btn btn-sm btn-primary add-food\">Uložit</a>';
            //$('html', 'body').animate({scrollTop: $('footer').offset().top}, 'fast');
            window.scrollTo(0, document.body.scrollHeight);

            only_numbers_listener();
        }

        // funke k přidání jídla
        function add_food(id) {
            console.log(id);
            $("#loading").modal("show");
            // vytáhne si z přidaného řádku info
            const name = document.getElementById(id).getElementsByClassName("food_name")[0].innerText;
            const description = document.getElementById(id).getElementsByClassName("food_description")[0].innerText;
            const price = document.getElementById(id).getElementsByClassName("food_price")[0].innerText;
            const selector = document.getElementById(id).getElementsByClassName("food_type")[0];
            const type = selector[selector.selectedIndex].getAttribute('data-id');
            // napere to do struktury
            const food = {
                id: id,
                name: name,
                description: description,
                price: price,
                type: type
            };
            // pošle do FoodControlleru
            try {
                const response = fetch('/foods/add', {
                    method: 'POST',
                    body: JSON.stringify(food),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(res => window.location.reload());
                console.log('Success');
            } catch (error) {
                console.error('Error:', error);
            }
            $("#loading").modal("hide");
        }

        function add_tag(e) {
            //TODO sranda, d2l8 to random v2ci xD
            let food_id = $(e).data('id');
                let form = document.getElementById("form_tags");
                let checkboxes = form.getElementsByClassName("form-checkbox");
            for (let i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = false;
            }
            document.getElementById(food_id).querySelectorAll('.food_tag').forEach(
                function(e) {
                    let tag_id = e.getAttribute('data-id');
                    for (let i = 0; i < checkboxes.length; i++) {
                        if (checkboxes[i].getAttribute('value') === tag_id) {
                            checkboxes[i].checked = true;
                        }
                    }
                }
            );
            document.getElementById('form_id').value = food_id;
            $("#addTagFormModal").modal("show");

            //$("#addTagFormModal").modal("hide");
        }

        function push_if_not_there(array, element) {
            if (array.indexOf(element) === -1) {
                array.push(element);
            }
        }

        function isNumber(n) {
            return !isNaN(parseFloat(n)) && isFinite(n);
        }

        function only_numbers_listener() {
            $(".only-numbers").keydown(function (event) {
                // Allow: backspace, delete, tab, escape, and enter
                if (event.keyCode == 46 || event.keyCode == 8 || event.keyCode == 9 || event.keyCode == 27 || event.keyCode == 13 ||
                    // Allow: Ctrl+A
                    (event.keyCode == 65 && event.ctrlKey === true) ||
                    // Allow: home, end, left, right
                    (event.keyCode >= 35 && event.keyCode <= 39)) {
                    // let it happen, don't do anything
                    return;
                } else {
                    // Ensure that it is a number and stop the keypress
                    if (event.shiftKey || (event.keyCode < 48 || event.keyCode > 57) && (event.keyCode < 96 || event.keyCode > 105)) {
                        event.preventDefault();
                    }
                }
            });
        }

        let changed_foods = [];
        function add_to_changed_foods(e) {
            push_if_not_there(changed_foods, e.id);
            console.log(changed_foods);
        }

        function save_all_changed() {
            changed_foods.forEach(function (food) {
                edit_food(food);
            });

            let adding_foods = document.getElementsByClassName("adding_row");
            console.log(adding_foods);
            for(let i = 0; i < adding_foods.length; i++) {
                add_food(adding_foods[i].id);
            }

            window.location.reload();
        }
    </script>
{% endblock %}